name: Deployment

on:
  workflow_dispatch:

jobs:
  deploy-stage:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment:
      name: stage
    defaults:
      run:
        working-directory: './infrastructure'
    env:
      TARGET_ENVIRONMENT: stage
      ARM_CLIENT_ID: ${{secrets.ARM_CLIENT_ID}}
      ARM_CLIENT_SECRET: ${{secrets.ARM_CLIENT_SECRET}}
      ARM_TENANT_ID: ${{secrets.ARM_TENANT_ID}}
      ARM_SUBSCRIPTION_ID: ${{secrets.ARM_SUBSCRIPTION_ID}}
      TF_VAR_secret_1: ${{ secrets.SECRET_1 }}
      TF_VAR_secret_2: ${{ secrets.SECRET_2 }}
      TF_VAR_name_prefix: ${{ secrets.DEPLOYMENT_NAME_PREFIX }}

    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v2

      - name: 'HashiCorp - Setup Terraform'
        uses: hashicorp/setup-terraform@v1.2.1

      - name: Format
        run: terraform fmt -check

      - name: Init
        run: terraform init -backend-config="storage_account_name=${{ secrets.TFSTATE_STORAGE_ACCOUNT_NAME }}" -backend-config="${{ env.TARGET_ENVIRONMENT }}.tfbackend"

      - name: Validate
        run: terraform validate -no-color

      - name: Plan
        run: terraform plan -var-file="${{ env.TARGET_ENVIRONMENT }}.tfvars" -no-color -out=plan.tfdata

      - name: Apply
        run: terraform apply -var-file="${{ env.TARGET_ENVIRONMENT }}.tfvars" -auto-approve plan.tfdata
