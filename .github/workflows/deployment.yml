name: Deployment

on:
  workflow_dispatch:

jobs:
  deploy-stage-infrastructure:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment:
      name: stage
    defaults:
      run:
        working-directory: './infrastructure'
    env:
      TARGET_ENVIRONMENT: stage
      ARM_CLIENT_ID: ${{secrets.ARM_CLIENT_ID}}
      ARM_CLIENT_SECRET: ${{secrets.ARM_CLIENT_SECRET}}
      ARM_TENANT_ID: ${{secrets.ARM_TENANT_ID}}
      ARM_SUBSCRIPTION_ID: ${{secrets.ARM_SUBSCRIPTION_ID}}
      TF_VAR_secret_1: ${{ secrets.SECRET_1 }}
      TF_VAR_secret_2: ${{ secrets.SECRET_2 }}
      TF_VAR_name_prefix: ${{ secrets.DEPLOYMENT_NAME_PREFIX }}
    outputs:
      FUNCTION_ONE_APP_NAME_OUTPUT: ${{ steps.set-tf-output.outputs.FUNCTION_ONE_APP_NAME }}

    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1.2.1
        with:
          terraform_wrapper: false

      - name: Terraform fmt
        run: terraform fmt -check

      - name: Terraform init
        run: terraform init -backend-config="storage_account_name=${{ secrets.TFSTATE_STORAGE_ACCOUNT_NAME }}" -backend-config="${{ env.TARGET_ENVIRONMENT }}.tfbackend"

      - name: Terraform validate
        run: terraform validate -no-color

      - name: Terraform plan
        run: terraform plan -var-file="${{ env.TARGET_ENVIRONMENT }}.tfvars" -no-color -out=plan.tfdata

      - name: Terraform apply
        run: terraform apply -auto-approve plan.tfdata

      - name: Terraform get outputs
        id: set-tf-output
        run: |
          echo "::set-output name=FUNCTION_ONE_APP_NAME::$(terraform output function_app_one_name)"

  deploy-stage-function:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [deploy-stage-infrastructure]
    environment:
      name: stage
    steps:
      - uses: actions/checkout@v2
        name: Checkout branch

      - run: echo ${{ needs.deploy-stage-infrastructure.outputs.FUNCTION_ONE_APP_NAME_OUTPUT }}

      - name: Deploy Function One
        uses: ./.github/actions/deploy-az-func
        with:
          working-directory: './src/function_one'
          target-function-app: ${{ needs.deploy-stage-infrastructure.outputs.FUNCTION_ONE_APP_NAME_OUTPUT }}
          az-rbac-credentials: ${{ secrets.AZURE_RBAC_CREDENTIALS }}

  deploy-production-infrastructure:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [deploy-stage-infrastructure]
    environment:
      name: production
    defaults:
      run:
        working-directory: './infrastructure'
    outputs:
      FUNCTION_ONE_APP_NAME: ${{ steps.tf_outputs.FUNCTION_ONE_APP_NAME }}

    env:
      TARGET_ENVIRONMENT: production
      ARM_CLIENT_ID: ${{secrets.ARM_CLIENT_ID}}
      ARM_CLIENT_SECRET: ${{secrets.ARM_CLIENT_SECRET}}
      ARM_TENANT_ID: ${{secrets.ARM_TENANT_ID}}
      ARM_SUBSCRIPTION_ID: ${{secrets.ARM_SUBSCRIPTION_ID}}
      TF_VAR_secret_1: ${{ secrets.SECRET_1 }}
      TF_VAR_secret_2: ${{ secrets.SECRET_2 }}
      TF_VAR_name_prefix: ${{ secrets.DEPLOYMENT_NAME_PREFIX }}

    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1.2.1
        with:
          terraform_wrapper: false

      - name: Terraform fmt
        run: terraform fmt -check

      - name: Terraform init
        run: terraform init -backend-config="storage_account_name=${{ secrets.TFSTATE_STORAGE_ACCOUNT_NAME }}" -backend-config="${{ env.TARGET_ENVIRONMENT }}.tfbackend"

      - name: Terraform validate
        run: terraform validate -no-color

      - name: Terraform plan
        run: terraform plan -var-file="${{ env.TARGET_ENVIRONMENT }}.tfvars" -no-color -out=plan.tfdata

      - name: Terraform apply
        run: terraform apply -auto-approve plan.tfdata

      - name: Terraform get output
        id: tf_outputs
        run: |
          function_app_one_name=$(terraform output function_app_one_name)
          echo "::set-output name=FUNCTION_ONE_APP_NAME::$function_app_one_name"        